# Autoscaler

Scale your woodpecker agents automatically to the moon and back based on the current load.

## Usage

If you are using docker-compose you can add the following to your `docker-compose.yml` file:

```yml
# docker-compose.yml
version: '3'

services:
  woodpecker-server:
    image: woodpeckerci/woodpecker-server:next
    [...]

  woodpecker-autoscaler:
    image: woodpeckerci/autoscaler:next
    restart: always
    depends_on:
      - woodpecker-server
    environment:
      - WOODPECKER_SERVER=woodpecker-server:8000 # the url of your woodpecker server / could also be a public url
      - WOODPECKER_TOKEN=${WOODPECKER_TOKEN} # the api token you can get from the UI http://your-woodpecker-server.tld/user
      - WOODPECKER_MIN_AGENTS=0
      - WOODPECKER_MAX_AGENTS=3
      - WOODPECKER_WORKFLOWS_PER_AGENT=2 # the number of workflows each agent can run at the same time
      - WOODEPCKER_GRPC_ADDR=woodpecker-server:9000 # the grpc address of your woodpecker server
      - WOODEPCKER_GRPC_SECURE=false
      - WOODPECKER_AGENT_ENV=WOODPECKER_BACKEND_DOCKER_NETWORK=woodpecker
      - WOODPECKER_PROVIDER=hetzner
      - WOODPECKER_HETZNER_API_TOKEN=${WOODPECKER_HETZNER_API_TOKEN} # your api token for hetzner cloud

networks:
  default:
    external:
      name: woodpecker # create an external networks which will also be assigned to the agents so they can connect to the server
```

The agents will use `WOODEPCKER_GRPC_ADDR` and a token automatically generated by the autoscaler to connect to the server.Therefore the `WOODEPCKER_GRPC_ADDR` has to be accessible from the newly created agents.

## Roadmap

- [ ] Add support for multiple providers
  - [x] Hetzner
  - [ ] Amazon AWS
  - [ ] Google Cloud
  - [ ] Azure
  - [ ] Digital Ocean
  - [ ] Linode
  - [ ] Oracle Cloud
  - [ ] Equinix Metal
- [ ] Cleanup agents
  - [x] Remove agents which exist on the provider but are not in the server list (they wont be able to connect to the server anyway as their is no agent token for them)
  - [x] Remove agents from server list which do not exist on the provider
  - [ ] Remove agents which have not connected for a long time
- [x] Release as container image
- [x] Add docs
- [ ] Support agent deployment with specific attributes (e.g. platforms, architectures, etc.)
